#!/usr/bin/env bash
# poor man's i3blocks, it's all I need really
# see: man swaybar-protocol
echo '{"version": 1}'
echo "["
while true; do

date=$(date '+%A %d.%m.%y, %H:%M')

if [ "$(dunstctl is-paused)" = "true" ]; then
	notifications="ðŸ”•"
else
	notifications="ðŸ””"
fi

if [ "$(cat /sys/class/power_supply/BAT0/status)" = "Discharging" ]; then
	bat="ðŸ”‹ $(cat /sys/class/power_supply/BAT0/capacity)%"
else
	bat="ðŸ’« $(cat /sys/class/power_supply/BAT0/capacity)%"
fi

if [ "$(cat /sys/class/power_supply/BAT0/status)" = "Discharging" ] && [ "$(cat /sys/class/power_supply/BAT0/capacity)" -lt "25" ]; then
	echo -n '[{"background": "#000000","color":"#ff0000","full_text":"  '
else
	echo -n '[{"background": "#000000","color":"#36f8ff","full_text":"  '
fi

cpu() {
	read -r cpu a b c previdle rest < /proc/stat
	prevtotal=$((a+b+c+previdle))
	sleep 0.5
	read -r cpu a b c idle rest < /proc/stat
	total=$((a+b+c+idle))
	cpu=$((100*( (total-prevtotal) - (idle-previdle) ) / (total-prevtotal) ))
	echo "ðŸ§  $cpu"%
}

disk() {
	free=$(df -h | awk '/\/$/ {print $5}')
	echo "ðŸ’¾ $free"
}


scratches=$(scratches)
if [ "$scratches" -gt "0" ]; then
	scratches="ðŸ™ˆ $scratches"
else
	scratches=""
fi

sessions="ðŸ–¥ï¸ $(tmux ls | wc -l || 0)"
cpu=$(cpu)
disk=$(disk)

case $HOSTNAME in
	carb) echo -n "$bat   $notifications $sessions $scratches $disk $cpu    $date";;
 	yharnam) echo -n "$notifications $sessions $scratches $disk $cpu   $date";;
esac
echo -n '  "}],'
echo
sleep 2
done
